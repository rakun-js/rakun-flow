import{context,mono,Void}from"rakun";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _toPropertyKey(arg){var key=function(input,hint){if("object"!==_typeof(input)||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!==_typeof(res))return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}(arg,"string");return"symbol"===_typeof(key)?key:String(key)}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _defineProperty(obj,key,value){return(key=_toPropertyKey(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var rakunFlowPathParentProvider=context.create(null),rakunFlowSnapshotProvider=context.create(null),emitEvents=function(snapshot){return snapshot.getEvents().forEach((function(e){return snapshot.eventEmitter.emit(e[0],e[1])})),snapshot.setEvents([]),mono.then()},getCacheState=function getCacheState(path,type,snapshot){return mono.just(snapshot.getState(path,type)).flatPipe((function(state){return"hasValue"!=state.state&&snapshot.parent?getCacheState(path,type,snapshot.parent):mono.just(snapshot.getState(path,type))}))};function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _arrayLikeToArray$1(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _unsupportedIterableToArray$1(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray$1(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$1(o,minLen):void 0}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_x,_r,_arr=[],_n=!0,_d=!1;try{if(_x=(_i=_i.call(arr)).next,0===i){if(Object(_i)!==_i)return;_n=!1}else for(;!(_n=(_s=_x.call(_i)).done)&&(_arr.push(_s.value),_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{if(!_n&&null!=_i.return&&(_r=_i.return(),Object(_r)!==_r))return}finally{if(_d)throw _e}}return _arr}}(arr,i)||_unsupportedIterableToArray$1(arr,i)||_nonIterableRest()}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray$1(arr)}(arr)||_iterableToArray(arr)||_unsupportedIterableToArray$1(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var eventemitter3=function(fn){var module={exports:{}};return fn(module,module.exports),module.exports}((function(module){var has=Object.prototype.hasOwnProperty,prefix="~";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function addListener(emitter,event,fn,context,once){if("function"!=typeof fn)throw new TypeError("The listener must be a function");var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;return emitter._events[evt]?emitter._events[evt].fn?emitter._events[evt]=[emitter._events[evt],listener]:emitter._events[evt].push(listener):(emitter._events[evt]=listener,emitter._eventsCount++),emitter}function clearEvent(emitter,evt){0==--emitter._eventsCount?emitter._events=new Events:delete emitter._events[evt]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return[];if(handlers.fn)return[handlers.fn];for(var i=0,l=handlers.length,ee=new Array(l);i<l;i++)ee[i]=handlers[i].fn;return ee},EventEmitter.prototype.listenerCount=function(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];return listeners?listeners.fn?1:listeners.length:0},EventEmitter.prototype.emit=function(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function(event,fn,context){return addListener(this,event,fn,context,!1)},EventEmitter.prototype.once=function(event,fn,context){return addListener(this,event,fn,context,!0)},EventEmitter.prototype.removeListener=function(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return clearEvent(this,evt),this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||clearEvent(this,evt);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:clearEvent(this,evt)}return this},EventEmitter.prototype.removeAllListeners=function(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&clearEvent(this,evt)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,module.exports=EventEmitter}));function n(n){for(var r=arguments.length,t=Array(r>1?r-1:0),e=1;e<r;e++)t[e-1]=arguments[e];throw Error("[Immer] minified error nr: "+n+(t.length?" "+t.map((function(n){return"'"+n+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function r(n){return!!n&&!!n[Q]}function t(n){var r;return!!n&&(function(n){if(!n||"object"!=typeof n)return!1;var r=Object.getPrototypeOf(n);if(null===r)return!0;var t=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return t===Object||"function"==typeof t&&Function.toString.call(t)===Z}(n)||Array.isArray(n)||!!n[L]||!!(null===(r=n.constructor)||void 0===r?void 0:r[L])||s(n)||v(n))}function i(n,r,t){void 0===t&&(t=!1),0===o(n)?(t?Object.keys:nn)(n).forEach((function(e){t&&"symbol"==typeof e||r(e,n[e],n)})):n.forEach((function(t,e){return r(e,t,n)}))}function o(n){var r=n[Q];return r?r.i>3?r.i-4:r.i:Array.isArray(n)?1:s(n)?2:v(n)?3:0}function u(n,r){return 2===o(n)?n.has(r):Object.prototype.hasOwnProperty.call(n,r)}function f(n,r,t){var e=o(n);2===e?n.set(r,t):3===e?n.add(t):n[r]=t}function s(n){return X&&n instanceof Map}function v(n){return q&&n instanceof Set}function p(n){return n.o||n.t}function l(n){if(Array.isArray(n))return Array.prototype.slice.call(n);var r=rn(n);delete r[Q];for(var t=nn(r),e=0;e<t.length;e++){var i=t[e],o=r[i];!1===o.writable&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(r[i]={configurable:!0,writable:!0,enumerable:o.enumerable,value:n[i]})}return Object.create(Object.getPrototypeOf(n),r)}function d(n,e){return void 0===e&&(e=!1),y(n)||r(n)||!t(n)||(o(n)>1&&(n.set=n.add=n.clear=n.delete=h),Object.freeze(n),e&&i(n,(function(n,r){return d(r,!0)}),!0)),n}function h(){n(2)}function y(n){return null==n||"object"!=typeof n||Object.isFrozen(n)}function b(r){var t=tn[r];return t||n(18,r),t}function _(){return U}function j(n,r){r&&(b("Patches"),n.u=[],n.s=[],n.v=r)}function O(n){g(n),n.p.forEach(S),n.p=null}function g(n){n===U&&(U=n.l)}function w(n){return U={p:[],l:U,h:n,m:!0,_:0}}function S(n){var r=n[Q];0===r.i||1===r.i?r.j():r.O=!0}function P(r,e){e._=e.p.length;var i=e.p[0],o=void 0!==r&&r!==i;return e.h.g||b("ES5").S(e,r,o),o?(i[Q].P&&(O(e),n(4)),t(r)&&(r=M(e,r),e.l||x(e,r)),e.u&&b("Patches").M(i[Q].t,r,e.u,e.s)):r=M(e,i,[]),O(e),e.u&&e.v(e.u,e.s),r!==H?r:void 0}function M(n,r,t){if(y(r))return r;var e=r[Q];if(!e)return i(r,(function(i,o){return A(n,e,r,i,o,t)}),!0),r;if(e.A!==n)return r;if(!e.P)return x(n,e.t,!0),e.t;if(!e.I){e.I=!0,e.A._--;var o=4===e.i||5===e.i?e.o=l(e.k):e.o,u=o,a=!1;3===e.i&&(u=new Set(o),o.clear(),a=!0),i(u,(function(r,i){return A(n,e,o,r,i,t,a)})),x(n,o,!1),t&&n.u&&b("Patches").N(e,t,n.u,n.s)}return e.o}function A(e,i,o,a,c,s,v){if(r(c)){var p=M(e,c,s&&i&&3!==i.i&&!u(i.R,a)?s.concat(a):void 0);if(f(o,a,p),!r(p))return;e.m=!1}else v&&o.add(c);if(t(c)&&!y(c)){if(!e.h.D&&e._<1)return;M(e,c),i&&i.A.l||x(e,c)}}function x(n,r,t){void 0===t&&(t=!1),!n.l&&n.h.D&&n.m&&d(r,t)}function z(n,r){var t=n[Q];return(t?p(t):n)[r]}function I(n,r){if(r in n)for(var t=Object.getPrototypeOf(n);t;){var e=Object.getOwnPropertyDescriptor(t,r);if(e)return e;t=Object.getPrototypeOf(t)}}function k(n){n.P||(n.P=!0,n.l&&k(n.l))}function E(n){n.o||(n.o=l(n.t))}function N(n,r,t){var e=s(r)?b("MapSet").F(r,t):v(r)?b("MapSet").T(r,t):n.g?function(n,r){var t=Array.isArray(n),e={i:t?1:0,A:r?r.A:_(),P:!1,I:!1,R:{},l:r,t:n,k:null,o:null,j:null,C:!1},i=e,o=en;t&&(i=[e],o=on);var u=Proxy.revocable(i,o),a=u.revoke,f=u.proxy;return e.k=f,e.j=a,f}(r,t):b("ES5").J(r,t);return(t?t.A:_()).p.push(e),e}function R(e){return r(e)||n(22,e),function n(r){if(!t(r))return r;var e,u=r[Q],c=o(r);if(u){if(!u.P&&(u.i<4||!b("ES5").K(u)))return u.t;u.I=!0,e=D(r,c),u.I=!1}else e=D(r,c);return i(e,(function(r,t){u&&function(n,r){return 2===o(n)?n.get(r):n[r]}(u.t,r)===t||f(e,r,n(t))})),3===c?new Set(e):e}(e)}function D(n,r){switch(r){case 2:return new Map(n);case 3:return Array.from(n)}return l(n)}var G,U,W="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),X="undefined"!=typeof Map,q="undefined"!=typeof Set,B="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,H=W?Symbol.for("immer-nothing"):((G={})["immer-nothing"]=!0,G),L=W?Symbol.for("immer-draftable"):"__$immer_draftable",Q=W?Symbol.for("immer-state"):"__$immer_state",Z=""+Object.prototype.constructor,nn="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:Object.getOwnPropertyNames,rn=Object.getOwnPropertyDescriptors||function(n){var r={};return nn(n).forEach((function(t){r[t]=Object.getOwnPropertyDescriptor(n,t)})),r},tn={},en={get:function(n,r){if(r===Q)return n;var e=p(n);if(!u(e,r))return function(n,r,t){var e,i=I(r,t);return i?"value"in i?i.value:null===(e=i.get)||void 0===e?void 0:e.call(n.k):void 0}(n,e,r);var i=e[r];return n.I||!t(i)?i:i===z(n.t,r)?(E(n),n.o[r]=N(n.A.h,i,n)):i},has:function(n,r){return r in p(n)},ownKeys:function(n){return Reflect.ownKeys(p(n))},set:function(n,r,t){var e=I(p(n),r);if(null==e?void 0:e.set)return e.set.call(n.k,t),!0;if(!n.P){var i=z(p(n),r),o=null==i?void 0:i[Q];if(o&&o.t===t)return n.o[r]=t,n.R[r]=!1,!0;if(function(n,r){return n===r?0!==n||1/n==1/r:n!=n&&r!=r}(t,i)&&(void 0!==t||u(n.t,r)))return!0;E(n),k(n)}return n.o[r]===t&&(void 0!==t||r in n.o)||Number.isNaN(t)&&Number.isNaN(n.o[r])||(n.o[r]=t,n.R[r]=!0),!0},deleteProperty:function(n,r){return void 0!==z(n.t,r)||r in n.t?(n.R[r]=!1,E(n),k(n)):delete n.R[r],n.o&&delete n.o[r],!0},getOwnPropertyDescriptor:function(n,r){var t=p(n),e=Reflect.getOwnPropertyDescriptor(t,r);return e?{writable:!0,configurable:1!==n.i||"length"!==r,enumerable:e.enumerable,value:t[r]}:e},defineProperty:function(){n(11)},getPrototypeOf:function(n){return Object.getPrototypeOf(n.t)},setPrototypeOf:function(){n(12)}},on={};i(en,(function(n,r){on[n]=function(){return arguments[0]=arguments[0][0],r.apply(this,arguments)}})),on.deleteProperty=function(r,t){return on.set.call(this,r,t,void 0)},on.set=function(r,t,e){return en.set.call(this,r[0],t,e,r[0])};var un=function(){function e(r){var e=this;this.g=B,this.D=!0,this.produce=function(r,i,o){if("function"==typeof r&&"function"!=typeof i){var u=i;i=r;var a=e;return function(n){var r=this;void 0===n&&(n=u);for(var t=arguments.length,e=Array(t>1?t-1:0),o=1;o<t;o++)e[o-1]=arguments[o];return a.produce(n,(function(n){var t;return(t=i).call.apply(t,[r,n].concat(e))}))}}var f;if("function"!=typeof i&&n(6),void 0!==o&&"function"!=typeof o&&n(7),t(r)){var c=w(e),s=N(e,r,void 0),v=!0;try{f=i(s),v=!1}finally{v?O(c):g(c)}return"undefined"!=typeof Promise&&f instanceof Promise?f.then((function(n){return j(c,o),P(n,c)}),(function(n){throw O(c),n})):(j(c,o),P(f,c))}if(!r||"object"!=typeof r){if(void 0===(f=i(r))&&(f=r),f===H&&(f=void 0),e.D&&d(f,!0),o){var p=[],l=[];b("Patches").M(r,f,p,l),o(p,l)}return f}n(21,r)},this.produceWithPatches=function(n,r){if("function"==typeof n)return function(r){for(var t=arguments.length,i=Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return e.produceWithPatches(r,(function(r){return n.apply(void 0,[r].concat(i))}))};var t,i,o=e.produce(n,r,(function(n,r){t=n,i=r}));return"undefined"!=typeof Promise&&o instanceof Promise?o.then((function(n){return[n,t,i]})):[o,t,i]},"boolean"==typeof(null==r?void 0:r.useProxies)&&this.setUseProxies(r.useProxies),"boolean"==typeof(null==r?void 0:r.autoFreeze)&&this.setAutoFreeze(r.autoFreeze)}var i=e.prototype;return i.createDraft=function(e){t(e)||n(8),r(e)&&(e=R(e));var i=w(this),o=N(this,e,void 0);return o[Q].C=!0,g(i),o},i.finishDraft=function(r,t){var i=(r&&r[Q]).A;return j(i,t),P(void 0,i)},i.setAutoFreeze=function(n){this.D=n},i.setUseProxies=function(r){r&&!B&&n(20),this.g=r},i.applyPatches=function(n,t){var e;for(e=t.length-1;e>=0;e--){var i=t[e];if(0===i.path.length&&"replace"===i.op){n=i.value;break}}e>-1&&(t=t.slice(e+1));var o=b("Patches").$;return r(n)?o(n,t):this.produce(n,(function(n){return o(n,t)}))},e}(),an=new un,fn=an.produce;an.produceWithPatches.bind(an),an.setAutoFreeze.bind(an),an.setUseProxies.bind(an),an.applyPatches.bind(an),an.createDraft.bind(an),an.finishDraft.bind(an);var produce=fn;function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var getInitialValue=function(type){return{type:type,dependencies:[],state:"loading",value:null}},RakunFlowSnapshotImpl=function(){function RakunFlowSnapshotImpl(parent){var _this=this;_classCallCheck(this,RakunFlowSnapshotImpl),this.parent=parent,_defineProperty(this,"eventEmitter",void 0),_defineProperty(this,"states",{}),_defineProperty(this,"events",[]),_defineProperty(this,"inProcess",!1),_defineProperty(this,"getState",(function(path,type){var _this$states$path;return null!==(_this$states$path=_this.states[path])&&void 0!==_this$states$path?_this$states$path:getInitialValue(type)})),this.eventEmitter=new eventemitter3}return _createClass(RakunFlowSnapshotImpl,[{key:"getEvents",value:function(){return this.events}},{key:"setEvents",value:function(events){this.events=events}},{key:"getValue",value:function(path){var _this$states$path2;return null===(_this$states$path2=this.states[path])||void 0===_this$states$path2?void 0:_this$states$path2.value}},{key:"addDependency",value:function(path,dependency,type){this.states=produce(this.states,(function(draft){var _draft$path;draft[path]=produce(null!==(_draft$path=draft[path])&&void 0!==_draft$path?_draft$path:getInitialValue(type),(function(d){d.dependencies.includes(dependency)||(d.dependencies=[].concat(_toConsumableArray(d.dependencies),[dependency]))}))}))}},{key:"hasDependency",value:function(path,dependency){var _this$states$path$dep,_this$states$path3;return(null!==(_this$states$path$dep=null===(_this$states$path3=this.states[path])||void 0===_this$states$path3?void 0:_this$states$path3.dependencies)&&void 0!==_this$states$path$dep?_this$states$path$dep:[]).includes(dependency)}},{key:"set",value:function(path,value,type){var _this2=this,_produce2=_slicedToArray(produce([this.states,this.events],(function(draft){_this2._recipeSet(path,value,draft,type)})),2),data=_produce2[0],events=_produce2[1];this.states=data,this.events=events}},{key:"getDependencies",value:function(path){var _this$states$path$dep2,_this$states$path4;return null!==(_this$states$path$dep2=null===(_this$states$path4=this.states[path])||void 0===_this$states$path4?void 0:_this$states$path4.dependencies)&&void 0!==_this$states$path$dep2?_this$states$path$dep2:[]}},{key:"_recipeReset",value:function(path,_ref){var _states$path$dependen,_states$path,_ref2=_slicedToArray(_ref,2),states=_ref2[0],events=_ref2[1];path in states&&(states[path]=produce(states[path],(function(d){d.state="loading",d.value=null})));var _step,_iterator=_createForOfIteratorHelper(null!==(_states$path$dependen=null===(_states$path=states[path])||void 0===_states$path?void 0:_states$path.dependencies)&&void 0!==_states$path$dependen?_states$path$dependen:[]);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _states$p,p=_step.value;"selector"==(null===(_states$p=states[p])||void 0===_states$p?void 0:_states$p.type)&&this._recipeReset(p,[states,events])}}catch(err){_iterator.e(err)}finally{_iterator.f()}events.push([path,states[path]])}},{key:"_recipeSet",value:function(path,value,_ref3,type){var _states$path2,_states$path$dependen2,_states$path3,_ref4=_slicedToArray(_ref3,2),states=_ref4[0],events=_ref4[1];states[path]=produce(null!==(_states$path2=states[path])&&void 0!==_states$path2?_states$path2:getInitialValue(type),(function(d){d.state="hasValue",d.value=value}));var _step2,_iterator2=_createForOfIteratorHelper(null!==(_states$path$dependen2=null===(_states$path3=states[path])||void 0===_states$path3?void 0:_states$path3.dependencies)&&void 0!==_states$path$dependen2?_states$path$dependen2:[]);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _states$p2,p=_step2.value;"selector"==(null===(_states$p2=states[p])||void 0===_states$p2?void 0:_states$p2.type)&&this._recipeReset(p,[states,events])}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}events.push([path,states[path]])}},{key:"reset",value:function(path){var _this3=this,_produce4=_slicedToArray(produce([this.states,this.events],(function(draft){_this3._recipeReset(path,draft)})),2),states=_produce4[0],events=_produce4[1];this.states=states,this.events=events}}]),RakunFlowSnapshotImpl}(),getSnapshotOrThrow=function(RakunFlowSnapshot){return null!=RakunFlowSnapshot?mono.just(RakunFlowSnapshot):mono.error(new Error("NotFound RakunFlowSnapshot"))},createSnapshot=function(parent){return new RakunFlowSnapshotImpl(parent)},getSnapshot=function(){return rakunFlowSnapshotProvider.get().flatPipe(getSnapshotOrThrow)},setCacheValue=function(path,type,snapshot,value){return mono.fromCallback((function(){return snapshot.set(path,value,type),Void}))},get=function(snapshot,path,_get2,type){return rakunFlowPathParentProvider.get().flatPipe((function(value){return value?function(snapshot,path,dependency,type){return mono.fromCallback((function(){return snapshot.addDependency(path,dependency,type),Void}))}(snapshot,path,value,type).thenReturn(value):mono.just(value)})).flatPipe((function(oldPathParent){return rakunFlowPathParentProvider.define(path).then(_get2().flatPipe((function(v){return setCacheValue(path,type,snapshot,v).then(rakunFlowPathParentProvider.define(oldPathParent))})))})).flatPipe((function(){return emitEvents(snapshot)}))},recursive=function recursive(snapshot,path,type){return getCacheState(path,type,snapshot).flatPipe((function(){return snapshot.reset(path),snapshot.parent?recursive(snapshot.parent,path,type):mono.then()})).flatPipe((function(){return emitEvents(snapshot)}))},reset=function(path,type){return function(){return getSnapshot().flatPipe((function(RakunFlowSnapshot){return recursive(RakunFlowSnapshot,path,type)}))}},RakunFlowSnapshotManagerImpl=_createClass((function RakunFlowSnapshotManagerImpl(path,type){_classCallCheck(this,RakunFlowSnapshotManagerImpl),this.path=path,this.type=type,_defineProperty(this,"set",function(path,type){return function(value){return getSnapshot().flatPipe((function(snapshot){return setCacheValue(path,type,snapshot,value).then().flatPipe((function(){return emitEvents(snapshot)}))}))}}(this.path,this.type)),_defineProperty(this,"reset",reset(this.path,this.type)),_defineProperty(this,"subscribe",function(path){return function(callback){return getSnapshot().flatPipe((function(snapshot){return mono.fromCallback((function(){return snapshot.eventEmitter.on(path,callback),callback})).flatPipe((function(cb){return mono.just((function(){return snapshot.eventEmitter.removeListener(path,cb),mono.then()}))}))}))}}(this.path)),_defineProperty(this,"getState",function(path,type){return function(_get){return getSnapshot().flatPipe((function(snapshot){return getCacheState(path,type,snapshot).flatPipe((function(state){return"hasValue"==state.state?mono.just(state):get(snapshot,path,_get,type).then(getCacheState(path,type,snapshot))}))}))}}(this.path,this.type))})),createSnapshotManager=function(path,type){return new RakunFlowSnapshotManagerImpl(path,type)},RakunFlowAtomImpl=function(){function RakunFlowAtomImpl(config){var _this=this;_classCallCheck(this,RakunFlowAtomImpl),_defineProperty(this,"_default",void 0),_defineProperty(this,"path",void 0),_defineProperty(this,"manager",void 0),_defineProperty(this,"getState",(function(){return _this.manager.getState(_this._default)})),_defineProperty(this,"subscribe",(function(callback){return _this.manager.subscribe(callback)})),_defineProperty(this,"reset",(function(){return _this.manager.reset()})),_defineProperty(this,"set",(function(value){return _this.manager.set(value)})),this.path=config.path,this._default=config.default,this.manager=createSnapshotManager(this.path,"atom")}return _createClass(RakunFlowAtomImpl,[{key:"get",value:function(){return this.getState().pipe((function(s){return s.value}))}}]),RakunFlowAtomImpl}(),atom$1=function(config){return new RakunFlowAtomImpl({default:function(){return config.default},path:config.path})};var encode=function encode(fields,fieldNameArray,defualtValue){var arr,_fieldNameArray=_arrayWithHoles(arr=fieldNameArray)||_iterableToArray(arr)||_unsupportedIterableToArray$1(arr)||_nonIterableRest(),fieldName=_fieldNameArray[0],fieldNameArrayRest=_fieldNameArray.slice(1);return fieldName?"encode"in fields?fields.encode:encode(fields[Object.keys(fields).filter((function(_fieldName){return _fieldName==fieldName}))[0]],fieldNameArrayRest,defualtValue):function(){return defualtValue}},RakunFlowParamsImpl=function(){function RakunFlowParamsImpl(path,fields){_classCallCheck(this,RakunFlowParamsImpl),this.path=path,this.fields=fields}return _createClass(RakunFlowParamsImpl,[{key:"encode",value:function(params){var _this=this;return this.path.replace(/(:\w+)/g,(function(param){var fieldNameArray=param.substring(1).split(".");return encode(_this.fields,fieldNameArray,param)(params)}))}}]),RakunFlowParamsImpl}(),atomfamily=function(config){return function(params){var paramsBuild=new RakunFlowParamsImpl(config.path,config.params);return atom$1({default:config.default(params),path:paramsBuild.encode(params)})}},RakunFlowSelectorStateImpl=function(){function RakunFlowSelectorStateImpl(config,rakunFlowValue){_classCallCheck(this,RakunFlowSelectorStateImpl),this.rakunFlowValue=rakunFlowValue,_defineProperty(this,"_set",void 0),this._set=config.set}return _createClass(RakunFlowSelectorStateImpl,[{key:"path",get:function(){return this.rakunFlowValue.path}},{key:"getState",value:function(){return this.rakunFlowValue.getState()}},{key:"subscribe",value:function(callback){return this.rakunFlowValue.subscribe(callback)}},{key:"get",value:function(){return this.rakunFlowValue.get()}},{key:"set",value:function(value){return this._set(value)}},{key:"reset",value:function(){return this.rakunFlowValue.reset()}}]),RakunFlowSelectorStateImpl}(),RakunFlowSelectorValueImpl=function(){function RakunFlowSelectorValueImpl(config){var _this=this;_classCallCheck(this,RakunFlowSelectorValueImpl),_defineProperty(this,"_get",void 0),_defineProperty(this,"path",void 0),_defineProperty(this,"manager",void 0),_defineProperty(this,"getState",(function(){return _this.manager.getState((function(){return _this._get}))})),_defineProperty(this,"subscribe",(function(callback){return _this.manager.subscribe(callback)})),_defineProperty(this,"reset",(function(){return _this.manager.reset()})),this.path=config.path,this._get=config.get,this.manager=createSnapshotManager(this.path,"selector")}return _createClass(RakunFlowSelectorValueImpl,[{key:"get",value:function(){return this.getState().pipe((function(s){return s.value}))}}]),RakunFlowSelectorValueImpl}(),createSelector=function(config){return"set"in config?new RakunFlowSelectorStateImpl(config,new RakunFlowSelectorValueImpl(config)):new RakunFlowSelectorValueImpl(config)},param$1={string:{encode:function(v){return v},decode:function(v){return v}}};function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}var RakunFlowValue=_createClass((function RakunFlowValue(){_classCallCheck(this,RakunFlowValue),_defineProperty(this,"path",void 0)})),RakunFlowState=function(_RakunFlowValue){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(RakunFlowState,RakunFlowValue);var _super=_createSuper(RakunFlowState);function RakunFlowState(){return _classCallCheck(this,RakunFlowState),_super.apply(this,arguments)}return _createClass(RakunFlowState)}(),index={atomFamily:atomfamily,atom:atom$1,selector:createSelector},atomFamily=atomfamily,atom=atom$1,param=param$1,selector=createSelector,selectorFamily=function(config){return function(params){var paramsBuild=new RakunFlowParamsImpl(config.path,config.params);return createSelector("set"in config?{get:config.get(params),path:paramsBuild.encode(params),set:function(v){return config.set(params,v)}}:{get:config.get(params),path:paramsBuild.encode(params)})}};export{RakunFlowState,RakunFlowValue,atom,atomFamily,createSnapshot,index as default,getSnapshotOrThrow,param,rakunFlowPathParentProvider,rakunFlowSnapshotProvider,selector,selectorFamily};
